#!/usr/bin/env bash
set -euo pipefail

# If a directory was passed, use it; otherwise pick one via fzf
if [[ $# -ge 1 ]]; then
    selected=$1
else
    selected=$(
        {
            # Find project directories
            find "${HOME}/Code/repos" -maxdepth 3 -mindepth 1 -type d 2>/dev/null
            # Also offer /tmp explicitly
            printf '%s\n' /tmp
        } | fzf
    )
fi

# Exit if nothing selected
if [[ -z "${selected:-}" ]]; then
    exit 1
fi

# Normalize session name from directory basename
session_name=$(basename "$selected")
session_name=${session_name//./_}

# If the session already exists, attach/switch to it
if tmux has-session -t "$session_name" 2>/dev/null; then
    if [[ -n "${TMUX-}" ]]; then
        # Already inside tmux: switch client
        tmux switch-client -t "$session_name"
    else
        # Not inside tmux: attach to session
        tmux attach-session -t "$session_name"
    fi
    exit 0
fi

# Session does not exist yet: create and attach/switch
if [[ -n "${TMUX-}" ]]; then
    # Inside tmux: create detached session, then switch
    tmux new-session -d -s "$session_name" -c "$selected"
    tmux switch-client -t "$session_name"
else
    # Outside tmux: create and attach directly
    tmux new-session -s "$session_name" -c "$selected"
fi
